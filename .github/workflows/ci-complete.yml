name: CI Complete

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  # Security and dependency checks
  security-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # Backend security audit
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Backend security audit
        working-directory: apps/terminal-backend
        run: |
          python -m pip install --upgrade pip
          pip install safety
          pip install -e .[dev]
          safety check --json || echo "Security audit completed with warnings"
      
      # Frontend security audit
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: npm
          cache-dependency-path: apps/terminal-ui/package-lock.json
      - name: Frontend security audit
        working-directory: apps/terminal-ui
        run: |
          npm ci
          npm audit --audit-level high || echo "Security audit completed with warnings"

  # Code quality checks
  quality-gates:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: [backend, ui]
    steps:
      - uses: actions/checkout@v4
      
      - name: Backend quality checks
        if: matrix.component == 'backend'
        working-directory: apps/terminal-backend
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]
          echo "Running linting..."
          ruff check .
          echo "Running tests..."
          pytest -v
          echo "Running type checks (if available)..."
          python -c "import app.main; print('Import check passed')"
      
      - name: Frontend quality checks
        if: matrix.component == 'ui'
        working-directory: apps/terminal-ui
        run: |
          npm ci
          echo "Running linting..."
          npm run lint
          echo "Running tests..."
          npm test
          echo "Running build..."
          npm run build

  # Final validation
  integration-check:
    runs-on: ubuntu-latest
    needs: [security-audit, quality-gates]
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - name: Validation complete
        run: |
          echo "âœ… All CI checks passed successfully!"
          echo "ðŸ”’ Security audits completed"
          echo "ðŸ§ª Quality gates passed"
          echo "ðŸš€ Ready for review and merge"